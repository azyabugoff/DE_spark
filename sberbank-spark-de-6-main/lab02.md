## Лаба 2. По логу посещений найти сайты, релевантные для определенной группы пользователей – Apache Spark (RDD/Dataframe)


### Задача

Представьте, что вы занимаетесь разработкой DMP-системы. Она хранит в себе логи посещения пользователей в интернете и на основе этой информации может определять интересы этих пользователей. Эту информацию затем можно монетизировать за счет релевантной рекламы.

Но где нам лучше всего показывать рекламу для этих пользователей? Какие сайты для них являются релевантными? Через какие площадки пытаться достучаться до них? Первое, что приходит в голову — известные тематические порталы, но размещение рекламы там может быть дорогим.

После чего появляется другая мысль: “А может быть, мы можем найти такие сайты, на которые ходят наши пользователи, но они не являются такими очевидными и следовательно могут быть дешевле?”

#### Обработка данных на вход

Вы будете использовать датасет, лежащий на HDFS: `/labs/laba02`. В папке `logs` лежат логи посещения сайтов разными пользователями, а в корневой папке лежит файл со списком id тех пользователей, которые относятся к категории "Автолюбители". Кодировка на вход и выход - utf8. В логах каждая запись уникальное посещение.

**Логи** выглядят так:

```
26153949061 1422751272.768 http%3A%2F%2Frzd.ru%2F
```

Каждый файл представляет собой коллекцию записей, по записи на строчку, где каждая строка представляет собой кортеж `(UID, timestamp, URL)`:

- `UID` — уникальный идентификатор пользователя, представленый натуральным числом, записанным в десятичной форме.
- `timestamp` — отметка времени, записанная в форме UNIX timestamp, записана в виде десятичной дроби.
- `URL` — экранированный URL, представлен в виде строки. Записи разделены символом табуляции `\t`.

Файл со списком автолюбителей выглядит так:

```
{"autousers": ["100341861572", "100473724387", "100528753939", "101182896723", "101818209438", "101886368239", "102535398052", "103624582558", "103753741251", "104091409587",...]}
```

Необходимо определить, насколько тот или иной домен, из тех, что были ими посещены, является действительно релевантным для категории пользователей “Автомобилисты”.

#### Пояснение к классификации доменов

Имеется следующий отрывок лога, и известно, что пользователи `123` и `789` являются автомобилистами.

```
UID	Timestamp	URL
123	1354546464.210	http%3A%2F%2Fwww.cars.ru%2Fsample-page-1
123	1354546464.211	http%3A%2F%2Fauto.ru%2Fsample-page-2
123	8452135545.123	http%3A%2F%2Fya.ru%2Fsample-page-1
456	1234564654.231	http%3A%2F%2Fwww.ya.ru%2Fsample-page-1
456	8452135545.123	http%3A%2F%2Fauto.ru%2Fsample-page-1
456	4568797889.549	http%3A%2F%2Fya.ru%2Fstart
456	4568797889.549	http%3A%2F%2Fmarket.ya.ru%2Fstart
789	1234564654.231	http%3A%2F%2Fwww.auto.ru%2Fsample-page-1
789	1354546464.211	http%3A%2F%2Fwww.cars.ru%2Fsample-page-2
789	4568797889.549	http%3A%2F%2Fya.ru%2Fstart
```

Из этого лога можно получить более простую таблицу, состоящую из домена и бинарной переменной, которая показывает, был ли посещен этот домен пользователем-автомобилистом.

```
URL	Auto-flag
cars.ru		1
auto.ru		1
ya.ru		1
ya.ru		0
auto.ru		0
ya.ru		0
market.ya.ru	0
auto.ru		1
cars.ru		1
ya.ru		1
```

Домены `market.ya.ru`, `super.market.ya.ru`, `ya.ru` считаются разными.
Домены `www.ya.ru` и `ya.ru` считаются одинаковыми.

Брать в рассмотрение только URL с `http://` и `https://`. Классифицировать только тех пользователей, у которых в качестве `id` есть непустое значение (прочерк считать пустым значением).

URL’ы в виде прочерка также не брать в рассмотрение.

#### Обработка данных на выход

⚠️ Важно: Выходной файл должен быть расположен **НЕ в HDFS**, а в корне вашей домашней директории на мастер-ноде в файле `laba02_domains.txt`. 

В выходном файле все домены должны быть без `www.`и `http/s.` в начале url!!!.

Чекер будет брать файл именно оттуда.

Содержимое файла должно представлять собой список доменов релевантных для автомобилистов, упорядоченных по убыванию показателя релевантности, который рассчитывается следующим образом: 

![tex1](images/lab02_tex1.svg)

Это коэффициент Отиаи для двух произвольных множеств (в нашем случае: «Домен» и «Автомобилист»). Изначально он использовался в биологии (оценка встречаемости видов), но в дальнейшем распространился далеко за эти рамки.

В числителе стоит вероятность того, что наугад выбранная строка лога будет одновременно относиться к пользователю “Автомобилист” и интересующему домену, в квадрате. В знаменателе стоит произведение вероятности того, что наугад выбранная строка будет относиться к интересующему домену, и вероятности того, что наугад выбранная строка будет относиться к пользователю “Автомобилист”.

Таблица содержит два поля: `domain` и `relevance`.

На рассмотренном примере выходной файл будет следующим (второе поле представлено для лучшего понимания формулы расчета):

cars.ru: ![tex2](images/lab02_tex2.svg)

auto.ru: ![tex3](images/lab02_tex3.svg)

ya.ru: ![tex4](images/lab02_tex4.svg)

market.ya.ru: ![tex5](images/lab02_tex5.svg)

В выходном файле требуется список топ-200 доменов, по убыванию релевантности.

Релевантность — это число, а не строка. В случае одинаковой релевантности, отсортировать по домену лексикографически в порядке возрастания.

Разделитель между доменом и релевантностью — символ табуляции. Проверьте, что у вас разделителем является именно таб, а не несколько пробелов. Это типичная и очень обидная ошибка.

Релевантность нужна с 15 знаками после точки. Чекер не будет обращать внимание на небольшие погрешности вычислений.

#### Подсказки

Пример правильных строчек из ответа:

`xn--80aakahknigpedfdm6u.xn--p1ai 0.00031373656935232430`

`пддонлайнэкзамен.рф	0.00004784276952224211`

### Проверка

Проверка осуществляется автоматическим скриптом из Личного кабинета.
