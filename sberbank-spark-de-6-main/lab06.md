# Lab06. Подготовка матрицы признаков по логам, лежащим на HDFS, для модели машинного обучения

## I. Задача с высоты птичьего полета

У вас имеется матрица `users x items` для датасета visits (логи магазина). Теперь добавим к этим данным датасет weblogs (информация о посещениях веб-сайтов пользователями), знакомый вам по Лабе 3. Таким образом, соединив эти два датасета вместе по ключу `uid`, вы получите датасет для тренировки модели определения половозрастной категории пользователя по его покупкам, просмотрам товаров и посещениям веб-сайтов.

В следующей работе вы обучите модель и примените ее на потоковых данных.

![Alt text](images/img6.png?raw=true "Архитектура")


## II. Конкретика

Возьмите датасет `weblogs` в `/labs/laba03/`, выделите из url домены приведенным ниже способом. Из этих доменов сделайте матрицу типа `users x items`. Для каждого юзера в колонке `domain_features` должен содержаться вектор с числами посещений каждого сайта из топ-1000 по посещениям или 0, если не посещал.
> Для получение вектора самых посещаемых доменов необходимо взять 1000 самых посещяемых доменов (без привязки к пользователю), затем отсортировать их по алфовиту. 
> Домен null не учитывается, все остальные домены учитываются в том виде, который получился из parse_url и удаления "www.". 
> Дополнительно чистить и переименовывать домены не нужно, иначе собьется порядок.

Из временных меток посещения сайтов (по всем доменам) сделайте следующие признаки (колонки):

* число посещений по дням недели. То есть, постройте 7 признаков - "web_day_mon", "web_day_tue", ... , "web_day_sun" и прибавьте 1 для каждой метки, которая попадает на тот или иной день недели.
* число посещений по часам в сутках. Аналогично дням недели: "web_hour_0", ... "web_hour_23".
* долю посещений в рабочие часы "web_fraction_work_hours" (число посещений в рабочие часы/общее число посещений данного клиента) и долю посещений в вечерние часы "web_fraction_evening_hours", где рабочие часы - [9, 18), а вечерние - [18, 24).

Предупреждения и подсказки:

* в этом датасете в каждой строчке уникальный пользователь, повторений нет.
* посещения - число записей в поле visits. Если у одного пользователя встречается тот же url и та же временная метка два раза - все равно это два посещения.
* :warning: Внимание, часы считаются во временной зоне UTC
> Скорее всего, потребуется обращаться к колонкам, не зная их наименования. 
> У Спарка не работает функция col() на названия колонок с точкой внутри. 
> Чтобы обратиться к колонке с точкой можно использовать символ \`. Пример: col(\`columnName\`).

### Как сделать domain features

#### Экстракция URL:

```
.withColumn("host", lower(callUDF("parse_url", $"visit.url", lit("HOST"))))
                        .withColumn("domain", regexp_replace($"host", "www.", ""))
```

#### Реализация

Вариант "попроще" - возпользоваться pivot, потом собрать вектор в отдельную колонку.

Вариант "посложнее" - реализуйте облегченный вариант CountVectorizer из пакета Spark ML.

В любом случае, ваш выходной вектор (частоты посещений) должен быть упорядочен в алфавитном порядке соответствующих доменов, так как чекер будет проверять число посещений по вполне конктретным индексам.

Слейте этот датасет с матрицей `users-items` из лабы 05 (версия 20200429, которая должна храниться у вас в домашней директории HDFS `/user/name.surname/users-items/20200429`) по ключу `uid`, чтобы получился один большой датасет. Используйте для этого опцию `full` у join'а.

Сохраните в формате parquet по пути `/user/name.surname/features`.


## III. Оформление работы

В вашем репо в подпапке `lab06/features` положите sbt-project под названием `features` с главным классом `features` в файле `features.scala`.

Проект должен компилироваться и запускаться следующим образом:

```
cd lab06/features
sbt package
spark-submit --class features .target/scala-2.11/features_2.11-1.0.jar 
```
Обратите внимание на версию проекта - 1.0. Не забывайте о правильно заполненном .gitignore в корне репозитория. 

## IV. Проверка

Чекер считает матрицу `features` и проверит её выборочно для какого-то пользователя. Запуск вашего проекта производится не будет.

### Поля чекера

* `00_git_correct` - True/False присутствует файл features.scala
* `01_info_git_errors` - ошибки проверки репозитория 
* `02_domain_features1_correct` - True/False - проверка колонки с вектором domain_features
* `03_info_domain_features1_your_data` = "",
* `04_info_domain_features1_errors` = "",
* `05_time_features1_correct` - True/False - проверка признаков, основанных на временных метках.
* `06_info_time_features1_your_data` = "",
* `07_info_time_features1_errors` = "",
* `08_item_features1_correct` - True/False, - проверка признаков, основанных на покупках или просмотрах в магазине
* `09_info_item_features1_your_data` = "",
* `10_info_item_features1_errors` = "",
* `11_info_your_data` - остальные ваши данные
* `12_info_errors` - остальные ошибки, если есть
* `13_lab_result` - True/False


Логи чекера доступны по пути: `/tmp/logs/sb1laba06/$username/lab.log`
